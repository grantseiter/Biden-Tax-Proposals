// ===========================================================#
// Title: "qbided-cfn"
// File_Author: "Grant M. Seiter -- American Enterprise Institute"
// Date: "September 2020"
// Notes: "calculate qualified business income deduction"
          "calcfunc lines 810-820"
// ===========================================================#

@iterate_jit(nopython=True)
def TaxInc(c00100, standard, c04470, c04600, MARS, e00900, e26270,
           e02100, e27200, e00650, c01000,
           PT_SSTB_income, PT_binc_w2_wages, PT_ubia_property,
           PT_qbid_rt, PT_qbid_taxinc_thd, PT_qbid_taxinc_gap,
           PT_qbid_w2_wages_rt,
           PT_qbid_alt_w2_wages_rt, PT_qbid_alt_property_rt,
           c04800, qbided):
    """
    Calculates taxable income, c04800, and
    qualified business income deduction, qbided.

    """
    # calculate taxable income before qualified business income deduction
    pre_qbid_taxinc = max(0., c00100 - max(c04470, standard) - c04600)
    # calculate qualified business income deduction
    qbided = 0.
    qbinc = max(0., e00900 + e26270 + e02100 + e27200)
    qbided_full = qbinc * PT_qbid_rt
    if PT_qbid_taxinc_thd[MARS-1] > 0:
        if pre_qbid_taxinc < PT_qbid_taxinc_thd[MARS-1]:
            qbided = qbided_full
        else:
            qbided = max(0., qbided_full * (1 - (pre_qbid_taxinc - PT_qbid_taxinc_thd[MARS-1])/ PT_qbid_taxinc_gap[MARS-1]))
    else:
        qbided = qbided_full
